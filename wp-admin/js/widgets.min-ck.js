var wpWidgets;(function(e){wpWidgets={init:function(){var t,n=e("div.widgets-sortables"),r="undefined"!=typeof isRtl&&!!isRtl,i=isRtl?"marginRight":"marginLeft",s;e("#widgets-right").children(".widgets-holder-wrap").children(".sidebar-name").click(function(){var t=e(this).siblings(".widgets-sortables"),n=e(this).parent();if(!n.hasClass("closed")){t.sortable("disable");n.addClass("closed")}else{n.removeClass("closed");t.sortable("enable").sortable("refresh")}});e("#widgets-left").children(".widgets-holder-wrap").children(".sidebar-name").click(function(){e(this).parent().toggleClass("closed")});n.each(function(){if(e(this).parent().hasClass("inactive"))return!0;var t=50,n=e(this).children(".widget").length;t+=parseInt(n*48,10);e(this).css("minHeight",t+"px")});e(document.body).bind("click.widgets-toggle",function(t){var n=e(t.target),r={},s,o,u;if(n.parents(".widget-top").length&&!n.parents("#available-widgets").length){s=n.closest("div.widget");o=s.children(".widget-inside");u=parseInt(s.find("input.widget-width").val(),10);if(o.is(":hidden")){if(u>250&&o.closest("div.widgets-sortables").length){r.width=u+30+"px";o.closest("div.widget-liquid-right").length&&(r[i]=235-u+"px");s.css(r)}wpWidgets.fixLabels(s);o.slideDown("fast")}else o.slideUp("fast",function(){s.css({width:"",margin:""})});t.preventDefault()}else if(n.hasClass("widget-control-save")){wpWidgets.save(n.closest("div.widget"),0,1,0);t.preventDefault()}else if(n.hasClass("widget-control-remove")){wpWidgets.save(n.closest("div.widget"),1,1,0);t.preventDefault()}else if(n.hasClass("widget-control-close")){wpWidgets.close(n.closest("div.widget"));t.preventDefault()}});n.children(".widget").each(function(){wpWidgets.appendTitle(this);e("p.widget-error",this).length&&e("a.widget-action",this).click()});e("#widget-list").children(".widget").draggable({connectToSortable:"div.widgets-sortables",handle:"> .widget-top > .widget-title",distance:2,helper:"clone",zIndex:100,containment:"document",start:function(e,t){t.helper.find("div.widget-description").hide();s=this.id},stop:function(n,r){t&&e(t).hide();t=""}});n.sortable({placeholder:"widget-placeholder",items:"> .widget",handle:"> .widget-top > .widget-title",cursor:"move",distance:2,containment:"document",start:function(e,t){t.item.children(".widget-inside").hide();t.item.css({margin:"",width:""})},stop:function(n,r){r.item.hasClass("ui-draggable")&&r.item.data("draggable")&&r.item.draggable("destroy");if(r.item.hasClass("deleting")){wpWidgets.save(r.item,1,0,1);r.item.remove();return}var i=r.item.find("input.add_new").val(),o=r.item.find("input.multi_number").val(),u=s,l=e(this).attr("id");r.item.css({margin:"",width:""});s="";if(i){if("multi"==i){r.item.html(r.item.html().replace(/<[^<>]+>/g,function(e){return e.replace(/__i__|%i%/g,o)}));r.item.attr("id",u.replace("__i__",o));o++;e("div#"+u).find("input.multi_number").val(o)}else if("single"==i){r.item.attr("id","new-"+u);t="div#"+u}wpWidgets.save(r.item,0,0,1);r.item.find("input.add_new").val("");r.item.find("a.widget-action").click();return}wpWidgets.saveOrder(l)},receive:function(t,n){var r=e(n.sender);(!e(this).is(":visible")||this.id.indexOf("orphaned_widgets")!=-1)&&r.sortable("cancel");r.attr("id").indexOf("orphaned_widgets")!=-1&&!r.children(".widget").length&&r.parents(".orphan-sidebar").slideUp(400,function(){e(this).remove()})}}).sortable("option","connectWith","div.widgets-sortables").parent().filter(".closed").children(".widgets-sortables").sortable("disable");e("#available-widgets").droppable({tolerance:"pointer",accept:function(t){return e(t).parent().attr("id")!="widget-list"},drop:function(t,n){n.draggable.addClass("deleting");e("#removing-widget").hide().children("span").html("")},over:function(t,n){n.draggable.addClass("deleting");e("div.widget-placeholder").hide();n.draggable.hasClass("ui-sortable-helper")&&e("#removing-widget").show().children("span").html(n.draggable.find("div.widget-title").children("h4").html())},out:function(t,n){n.draggable.removeClass("deleting");e("div.widget-placeholder").show();e("#removing-widget").hide().children("span").html("")}})},saveOrder:function(t){t&&e("#"+t).closest("div.widgets-holder-wrap").find(".spinner").css("display","inline-block");var n={action:"widgets-order",savewidgets:e("#_wpnonce_widgets").val(),sidebars:[]};e("div.widgets-sortables").each(function(){e(this).sortable&&(n["sidebars["+e(this).attr("id")+"]"]=e(this).sortable("toArray").join(","))});e.post(ajaxurl,n,function(){e(".spinner").hide()});this.resize()},save:function(t,n,r,i){var s=t.closest("div.widgets-sortables").attr("id"),o=t.find("form").serialize(),u;t=e(t);e(".spinner",t).show();u={action:"save-widget",savewidgets:e("#_wpnonce_widgets").val(),sidebar:s};n&&(u.delete_widget=1);o+="&"+e.param(u);e.post(ajaxurl,o,function(s){var o;if(n){if(!e("input.widget_number",t).val()){o=e("input.widget-id",t).val();e("#available-widgets").find("input.widget-id").each(function(){e(this).val()==o&&e(this).closest("div.widget").show()})}if(r){i=0;t.slideUp("fast",function(){e(this).remove();wpWidgets.saveOrder()})}else{t.remove();wpWidgets.resize()}}else{e(".spinner").hide();if(s&&s.length>2){e("div.widget-content",t).html(s);wpWidgets.appendTitle(t);wpWidgets.fixLabels(t)}}i&&wpWidgets.saveOrder()})},appendTitle:function(t){var n=e('input[id*="-title"]',t).val()||"";n&&(n=": "+n.replace(/<[^<>]+>/g,"").replace(/</g,"&lt;").replace(/>/g,"&gt;"));e(t).children(".widget-top").children(".widget-title").children().children(".in-widget-title").html(n)},resize:function(){e("div.widgets-sortables").each(function(){if(e(this).parent().hasClass("inactive"))return!0;var t=50,n=e(this).children(".widget").length;t+=parseInt(n*48,10);e(this).css("minHeight",t+"px")})},fixLabels:function(t){t.children(".widget-inside").find("label").each(function(){var t=e(this).attr("for");t&&t==e("input",this).attr("id")&&e(this).removeAttr("for")})},close:function(e){e.children(".widget-inside").slideUp("fast",function(){e.css({width:"",margin:""})})}};e(document).ready(function(e){wpWidgets.init()})})(jQuery);