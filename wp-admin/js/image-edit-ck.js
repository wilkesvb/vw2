var imageEdit;(function(e){imageEdit={iasapi:{},hold:{},postid:"",intval:function(e){return e|0},setDisabled:function(t,n){if(n){t.removeClass("disabled");e("input",t).removeAttr("disabled")}else{t.addClass("disabled");e("input",t).prop("disabled",!0)}},init:function(t,n){var r=this,i=e("#image-editor-"+r.postid),s=r.intval(e("#imgedit-x-"+t).val()),o=r.intval(e("#imgedit-y-"+t).val());r.postid!=t&&i.length&&r.close(r.postid);r.hold.w=r.hold.ow=s;r.hold.h=r.hold.oh=o;r.hold.xy_ratio=s/o;r.hold.sizer=parseFloat(e("#imgedit-sizer-"+t).val());r.postid=t;e("#imgedit-response-"+t).empty();e('input[type="text"]',"#imgedit-panel-"+t).keypress(function(t){var n=t.keyCode;36<n&&n<41&&e(this).blur();if(13==n){t.preventDefault();t.stopPropagation();return!1}})},toggleEditor:function(t,n){var r=e("#imgedit-wait-"+t);n?r.height(e("#imgedit-panel-"+t).height()).fadeIn("fast"):r.fadeOut("fast")},toggleHelp:function(t){e(t).siblings(".imgedit-help").slideToggle("fast");return!1},getTarget:function(t){return e('input[name="imgedit-target-'+t+'"]:checked',"#imgedit-save-target-"+t).val()||"full"},scaleChanged:function(t,n){var r=e("#imgedit-scale-width-"+t),i=e("#imgedit-scale-height-"+t),s=e("#imgedit-scale-warn-"+t),o="",u="";if(n){u=r.val()!=""?Math.round(r.val()/this.hold.xy_ratio):"";i.val(u)}else{o=i.val()!=""?Math.round(i.val()*this.hold.xy_ratio):"";r.val(o)}u&&u>this.hold.oh||o&&o>this.hold.ow?s.css("visibility","visible"):s.css("visibility","hidden")},getSelRatio:function(t){var n=this.hold.w,r=this.hold.h,i=this.intval(e("#imgedit-crop-width-"+t).val()),s=this.intval(e("#imgedit-crop-height-"+t).val());return i&&s?i+":"+s:n&&r?n+":"+r:"1:1"},filterHistory:function(t,n){var r=e("#imgedit-history-"+t).val(),i,s,o,u,a=[];if(r!=""){r=JSON.parse(r);i=this.intval(e("#imgedit-undone-"+t).val());if(i>0)while(i>0){r.pop();i--}if(n){if(!r.length){this.hold.w=this.hold.ow;this.hold.h=this.hold.oh;return""}o=r[r.length-1];o=o.c||o.r||o.f||!1;if(o){this.hold.w=o.fw;this.hold.h=o.fh}}for(s in r){u=r[s];u.hasOwnProperty("c")?a[s]={c:{x:u.c.x,y:u.c.y,w:u.c.w,h:u.c.h}}:u.hasOwnProperty("r")?a[s]={r:u.r.r}:u.hasOwnProperty("f")&&(a[s]={f:u.f.f})}return JSON.stringify(a)}return""},refreshEditor:function(t,n,r){var i=this,s,o;i.toggleEditor(t,1);s={action:"imgedit-preview",_ajax_nonce:n,postid:t,history:i.filterHistory(t,1),rand:i.intval(Math.random()*1e6)};o=e('<img id="image-preview-'+t+'" />');o.load(function(){var n,i,s=e("#imgedit-crop-"+t),u=imageEdit;s.empty().append(o);n=Math.max(u.hold.w,u.hold.h);i=Math.max(e(o).width(),e(o).height());u.hold.sizer=n>i?i/n:1;u.initCrop(t,o,s);u.setCropSelection(t,0);typeof r!="unknown"&&r!=null&&r();e("#imgedit-history-"+t).val()&&e("#imgedit-undone-"+t).val()==0?e("input.imgedit-submit-btn","#imgedit-panel-"+t).removeAttr("disabled"):e("input.imgedit-submit-btn","#imgedit-panel-"+t).prop("disabled",!0);u.toggleEditor(t,0)}).error(function(){e("#imgedit-crop-"+t).empty().append('<div class="error"><p>'+imageEditL10n.error+"</p></div>");i.toggleEditor(t,0)}).attr("src",ajaxurl+"?"+e.param(s))},action:function(t,n,r){var i=this,s,o,u,a,f;if(i.notsaved(t))return!1;s={action:"image-editor",_ajax_nonce:n,postid:t};if("scale"==r){o=e("#imgedit-scale-width-"+t),u=e("#imgedit-scale-height-"+t),a=i.intval(o.val()),f=i.intval(u.val());if(a<1){o.focus();return!1}if(f<1){u.focus();return!1}if(a==i.hold.ow||f==i.hold.oh)return!1;s["do"]="scale";s.fwidth=a;s.fheight=f}else{if("restore"!=r)return!1;s["do"]="restore"}i.toggleEditor(t,1);e.post(ajaxurl,s,function(n){e("#image-editor-"+t).empty().append(n);i.toggleEditor(t,0)})},save:function(t,n){var r,i=this.getTarget(t),s=this.filterHistory(t,0);if(""==s)return!1;this.toggleEditor(t,1);r={action:"image-editor",_ajax_nonce:n,postid:t,history:s,target:i,context:e("#image-edit-context").length?e("#image-edit-context").val():null,"do":"save"};e.post(ajaxurl,r,function(n){var r=JSON.parse(n);if(r.error){e("#imgedit-response-"+t).html('<div class="error"><p>'+r.error+"</p><div>");imageEdit.close(t);return}r.fw&&r.fh&&e("#media-dims-"+t).html(r.fw+" &times; "+r.fh);r.thumbnail&&e(".thumbnail","#thumbnail-head-"+t).attr("src",""+r.thumbnail);r.msg&&e("#imgedit-response-"+t).html('<div class="updated"><p>'+r.msg+"</p></div>");imageEdit.close(t)})},open:function(t,n){var r,i=e("#image-editor-"+t),s=e("#media-head-"+t),o=e("#imgedit-open-btn-"+t),u=o.siblings(".spinner");o.prop("disabled",!0);u.show();r={action:"image-editor",_ajax_nonce:n,postid:t,"do":"open"};i.load(ajaxurl,r,function(){i.fadeIn("fast");s.fadeOut("fast",function(){o.removeAttr("disabled");u.hide()})})},imgLoaded:function(t){var n=e("#image-preview-"+t),r=e("#imgedit-crop-"+t);this.initCrop(t,n,r);this.setCropSelection(t,0);this.toggleEditor(t,0)},initCrop:function(t,n,r){var i=this,s=e("#imgedit-sel-width-"+t),o=e("#imgedit-sel-height-"+t);i.iasapi=e(n).imgAreaSelect({parent:r,instance:!0,handles:!0,keys:!0,minWidth:3,minHeight:3,onInit:function(e,n){r.children().mousedown(function(e){var n=!1,r,s;if(e.shiftKey){r=i.iasapi.getSelection();s=i.getSelRatio(t);n=r&&r.width&&r.height?r.width+":"+r.height:s}i.iasapi.setOptions({aspectRatio:n})})},onSelectStart:function(n,r){imageEdit.setDisabled(e("#imgedit-crop-sel-"+t),1)},onSelectEnd:function(e,n){imageEdit.setCropSelection(t,n)},onSelectChange:function(e,t){var n=imageEdit.hold.sizer;s.val(imageEdit.round(t.width/n));o.val(imageEdit.round(t.height/n))}})},setCropSelection:function(t,n){var r,i=e("#imgedit-minthumb-"+t).val()||"128:128",s=this.hold.sizer;i=i.split(":");n=n||0;if(!n||n.width<3&&n.height<3){this.setDisabled(e(".imgedit-crop","#imgedit-panel-"+t),0);this.setDisabled(e("#imgedit-crop-sel-"+t),0);e("#imgedit-sel-width-"+t).val("");e("#imgedit-sel-height-"+t).val("");e("#imgedit-selection-"+t).val("");return!1}if(n.width<i[0]*s&&n.height<i[1]*s){this.setDisabled(e(".imgedit-crop","#imgedit-panel-"+t),0);e("#imgedit-selection-"+t).val("");return!1}r={x:n.x1,y:n.y1,w:n.width,h:n.height};this.setDisabled(e(".imgedit-crop","#imgedit-panel-"+t),1);e("#imgedit-selection-"+t).val(JSON.stringify(r))},close:function(t,n){n=n||!1;if(n&&this.notsaved(t))return!1;this.iasapi={};this.hold={};e("#image-editor-"+t).fadeOut("fast",function(){e("#media-head-"+t).fadeIn("fast");e(this).empty()})},notsaved:function(t){var n=e("#imgedit-history-"+t).val(),r=n!=""?JSON.parse(n):new Array,i=this.intval(e("#imgedit-undone-"+t).val());return i<r.length?confirm(e("#imgedit-leaving-"+t).html())?!1:!0:!1},addStep:function(t,n,r){var i=this,s=e("#imgedit-history-"+n),o=s.val()!=""?JSON.parse(s.val()):new Array,u=e("#imgedit-undone-"+n),a=i.intval(u.val());while(a>0){o.pop();a--}u.val(0);o.push(t);s.val(JSON.stringify(o));i.refreshEditor(n,r,function(){i.setDisabled(e("#image-undo-"+n),!0);i.setDisabled(e("#image-redo-"+n),!1)})},rotate:function(t,n,r,i){if(e(i).hasClass("disabled"))return!1;this.addStep({r:{r:t,fw:this.hold.h,fh:this.hold.w}},n,r)},flip:function(t,n,r,i){if(e(i).hasClass("disabled"))return!1;this.addStep({f:{f:t,fw:this.hold.w,fh:this.hold.h}},n,r)},crop:function(t,n,r){var i=e("#imgedit-selection-"+t).val(),s=this.intval(e("#imgedit-sel-width-"+t).val()),o=this.intval(e("#imgedit-sel-height-"+t).val());if(e(r).hasClass("disabled")||i=="")return!1;i=JSON.parse(i);if(i.w>0&&i.h>0&&s>0&&o>0){i.fw=s;i.fh=o;this.addStep({c:i},t,n)}},undo:function(t,n){var r=this,i=e("#image-undo-"+t),s=e("#imgedit-undone-"+t),o=r.intval(s.val())+1;if(i.hasClass("disabled"))return;s.val(o);r.refreshEditor(t,n,function(){var n=e("#imgedit-history-"+t),s=n.val()!=""?JSON.parse(n.val()):new Array;r.setDisabled(e("#image-redo-"+t),!0);r.setDisabled(i,o<s.length)})},redo:function(t,n){var r=this,i=e("#image-redo-"+t),s=e("#imgedit-undone-"+t),o=r.intval(s.val())-1;if(i.hasClass("disabled"))return;s.val(o);r.refreshEditor(t,n,function(){r.setDisabled(e("#image-undo-"+t),!0);r.setDisabled(i,o>0)})},setNumSelection:function(t){var n,r=e("#imgedit-sel-width-"+t),i=e("#imgedit-sel-height-"+t),s=this.intval(r.val()),o=this.intval(i.val()),u=e("#image-preview-"+t),a=u.height(),f=u.width(),l=this.hold.sizer,c,h,p,d,v=this.iasapi;if(s<1){r.val("");return!1}if(o<1){i.val("");return!1}if(s&&o&&(n=v.getSelection())){p=n.x1+Math.round(s*l);d=n.y1+Math.round(o*l);c=n.x1;h=n.y1;if(p>f){c=0;p=f;r.val(Math.round(p/l))}if(d>a){h=0;d=a;i.val(Math.round(d/l))}v.setSelection(c,h,p,d);v.update();this.setCropSelection(t,v.getSelection())}},round:function(e){var t;e=Math.round(e);if(this.hold.sizer>.6)return e;t=e.toString().slice(-1);return"1"==t?e-1:"9"==t?e+1:e},setRatioSelection:function(t,n,r){var i,s,o=this.intval(e("#imgedit-crop-width-"+t).val()),u=this.intval(e("#imgedit-crop-height-"+t).val()),a=e("#image-preview-"+t).height();if(!this.intval(e(r).val())){e(r).val("");return}if(o&&u){this.iasapi.setOptions({aspectRatio:o+":"+u});if(i=this.iasapi.getSelection(!0)){s=Math.ceil(i.y1+(i.x2-i.x1)/(o/u));if(s>a){s=a;n?e("#imgedit-crop-height-"+t).val(""):e("#imgedit-crop-width-"+t).val("")}this.iasapi.setSelection(i.x1,i.y1,i.x2,s);this.iasapi.update()}}}}})(jQuery);